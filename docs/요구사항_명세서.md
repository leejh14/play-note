# PlayNote 요구사항 & 유즈케이스 (v1.4)

## 0. 목표

동네 친구들과 하는 고정 컨텐츠(롤 내전/풋살)를 **세션 단위로 생성 → 참여 관리 → 팀 나누기 → 기록(댓글/이미지) → 롤은 통계 집계**까지 제공하는 서비스.

---

## 1. 핵심 원칙(결정사항)

- **글로벌 네비게이션**: 하단 탭 바 3탭 — **Sessions** | **Statistics** | **Friends**
  - Sessions: 세션 목록 (홈)
  - Statistics: 통계 개요 (Stats Overview → Stats Detail)
  - Friends: 친구 관리 (admin)
- **로그인 없이 사용 가능**
- 링크는 **단체 톡방(1개 고정)** 에 공유하며, 그 단톡방 멤버가 **잠재 참가자 풀**이다.
- 초대는 **세션 단위 초대 링크(토큰)** 형태
- **링크 가진 사람 모두 수정/삭제 가능(editor)**
- 개발자/운영을 위한 **Admin token**이 별도로 존재하며, Admin은 추가 운영 권한을 가진다.
- 세션 생성 시 **날짜/시간은 하나만 정해서 생성** (후보 투표 없음)
- 기록은
  - **댓글(텍스트 전용)** 로 커뮤니티 활성화
  - **이미지는 댓글에 첨부 불가** 이며, 별도 **기록/첨부(Attachments)** 영역에 업로드
- 이미지 업로드는 **세션당 최대 10장(롤/풋살 공통)**

---

## 2. 도메인/용어 정의

- **Friend(친구)**: 동네 친구 정보(전역 주소록). 통계 집계의 기준 단위.
- **Content(컨텐츠)**: 고정 템플릿 (예: 롤 내전, 풋살)
- **Session(세션)**: 특정 날짜/시간에 진행되는 1회 모임
- **Team(A/B)**: 세션에서 한 번 나누는 사람 팀(롤/풋살 공통)
- **Match(매치)**: 롤 세션 안에서 진행되는 1판(세션당 1..N)
- **Side(Blue/Red)**: LoL 게임 내 진영(매치마다 변경 가능)
- **Comment(댓글)**: 텍스트 전용 커뮤니티 기록
- **Attachment(첨부/기록 이미지)**: 댓글과 분리된 이미지 기록(세션/매치에 귀속)

---

## 3. Friend(전역 주소록) 정책

- Friend 목록은 **서비스 전역(단일 주소록)** 으로 관리한다.
- 저장 필드(개념)
  - 이름/표시명
  - 닉네임/별칭(aliases)
  - (가능하면) Riot ID (gameName / tagLine)
- Friend는 통계/매치 기록과 연결되므로, 기본 삭제 대신 **아카이브(비활성화)** 를 권장한다.

---

## 4. 세션 상태/플로우 (3-Screen)

### 4.1 세션 생성 (화면 1: Session Creation)

- 컨텐츠 선택 후, **날짜/시간 1개 확정값**으로 세션 생성
- 세션 링크를 단톡방에 공유

### 4.2 세션 셋업 (화면 2: Session Setup)

- 세션 생성 후 **셋업 화면**에서 사전 준비를 완료한다:
  1. **참가 상태 설정**: Friend별 참가/불참/미정
  2. **팀 배정**: ATTENDING 멤버를 Team A / Team B로 분배
  3. **라인 배정 (LoL만)**: 팀 멤버별 기본 라인 설정 (TOP/JG/MID/ADC/SUP)
- **완료(Confirm)** 버튼으로 셋업을 확정하면 세션이 `confirmed` 상태가 된다
- 셋업 확정 전까지 참가/팀/라인 자유롭게 변경 가능

### 4.3 세션 상세 (화면 3: Session Detail)

- 셋업 확정 후 **세션 상세 화면**에서 기록을 관리한다:
  - (LoL) 매치 생성 → 결과 확정
  - 첨부(사진/스크린샷) 업로드
  - 댓글 작성
- 셋업 정보(참가자, 팀, 라인)는 확정된 결과로 표시됨

### 4.4 셋업 변경 규칙(결정사항)

- **confirmed 이후에도 Attachment 0장이면** 셋업(참가/팀/라인) 수정 가능
- **Attachment가 1장이라도 업로드되면 잠김** (기본적으로 변경 제한)
- **Admin은 잠금 해제(Unlock) 가능**

### 4.5 세션 마감(done) 규칙(결정사항)

- **수동 전환**: editor/admin 모두 `confirmed → done` 전환 가능
- **자동 전환**: 세션 날짜(`startsAt`)로부터 **3일 경과** 시 자동으로 `done` 전환 (시스템 cron)
- **`done` 상태 제약**: 세션 수정(제목/날짜) 불가, 읽기 전용
- **복귀(reopen)**: **admin만** `done → confirmed`로 되돌리기 가능 (추가 매치/기록이 필요한 경우)
- `scheduled` 세션은 자동 마감 대상이 아님 (셋업 미완료 세션은 사용자가 직접 관리)

---

## 5. 참여 관리(Attendance)

- 셋업 화면에서 Friend별 **참가/불참/미정** 상태를 설정한다.
- 한 사람이 대신 참가자 상태를 관리할 수도 있다(권한이 동일하게 열려 있음).
- 기본 인원 대비 참가 인원 카운트 표시

---

## 6. 팀 나누기 + 라인 배정(롤/풋살 공통)

- **셋업 화면**에서 ATTENDING 멤버를 Team A / Team B로 분배한다.
- 풋살: 팀만 나누고 라인은 없다.
- 롤: 팀을 나눈 뒤, **셋업 화면에서 기본 라인까지 배정**한다.
- **풋살 팀 나누기는 세션 단위 1회**로 고정한다.
- 매치 생성 시 세션 팀 프리셋(팀 + 라인)이 자동 복사된다.

---

## 7. 롤 내전(LoL) 세부 요구사항

### 7.1 세션 내 Match 1..N

- 롤 세션 안에는 **Match가 여러 개** 생길 수 있다.

### 7.2 팀 프리셋 복사

- 세션에서 만든 Team A/B 구성을 **Match 생성 시 복사**해서 시작한다.

### 7.3 라인/챔피언

- **기본 라인은 세션 셋업 화면에서 배정** (TeamPresetMember에 저장)
- 매치 생성 시 기본 라인이 복사됨, **매치별로 변경 가능**
- **라인 표시 순서**: TOP → JG → MID → ADC → SUP (UI 및 정렬 기준)
- 챔피언은 **수동 입력 허용** (MVP)

### 7.4 Team(A/B) vs Side(Blue/Red) 분리

- Team A/B는 “사람 팀”
- Blue/Red는 “게임 진영”이며 **매치마다 변경될 수 있다**
- A↔Blue/Red 매핑 및 승/패는 **스샷을 기준으로 확정**한다.

### 7.5 롤 기록 이미지(지원 범위 고정)

- MVP에서 롤 기록 이미지는 **게임 종료 결과창 1종만 지원**
- 따라서 업로드되는 롤 이미지는 항상 **게임 종료 결과창 스샷**이다.

### 7.6 스샷 기반 확정 및 집계

- 결과창 스샷 업로드 → 자동 추출 시도(승/패/진영) → 사용자가 확인/수정 → **확정**
- **확정된 Match만 통계 집계에 포함**

---

## 8. 기록/커뮤니티

### 8.1 댓글(텍스트 전용)

- 댓글은 커뮤니티 활성화를 위한 **텍스트 전용** 기능이다.
- 댓글에 이미지는 첨부할 수 없다.

### 8.2 첨부(이미지 기록)

- 이미지 업로드는 별도 **Attachments** 영역에서 수행한다.
- 풋살: 세션 사진 업로드(기록용)
- 롤: 매치 결과창 스샷 업로드(집계용)
- 세션당 이미지 최대 10장(롤/풋살 공통)

---

## 9. 권한/토큰(세션 단위)

- 세션은 토큰을 가진다:
  - `editorToken`: 링크 가진 사람(생성/수정 가능)
  - `adminToken`: 개발자/운영 권한(잠금 해제, **삭제**, 토큰 회전 등)
- 삭제 권한: **admin만 가능** (세션 삭제, 매치 삭제)
- 수정 권한: editor/admin 모두 가능

---

## 10. 통계(필수)

확정된 롤 Match 데이터를 기반으로 Friend별 통계를 제공한다:

- 승률
- 자주 이긴 챔피언(수동 입력 데이터 기반)
- 선호 라인(선택된 lane 기반)

---

# 유즈케이스

## UC-1. 세션 생성 및 공유

1. 사용자가 컨텐츠(롤 내전/풋살)를 선택
2. 날짜/시간을 1개 지정해 세션 생성
3. 생성된 세션 링크를 단톡방에 공유
4. 단톡방 멤버들이 링크로 접속

**기대 결과**

- 로그인 없이 세션 상세 페이지 접근 가능
- 링크 가진 사람 모두 수정 가능

---

## UC-1-1. 세션 목록 조회

1. 홈 화면에서 세션 목록을 커서 기반 페이지네이션으로 조회
2. 컨텐츠 타입(All / LoL / Futsal)으로 필터링 가능

**기본 정렬**

- **1차**: 오늘 날짜와 가까운 순 (`|startsAt - NOW()|` 오름차순)
- **2차**: 세션 상태 우선순위 — confirmed(1) → scheduled(2) → done(3)
- **Tie-breaker**: id (PK)

**기대 결과**

- 진행 중/예정된 세션이 상단에, 완료된 세션은 하단에 자연 배치
- 무한 스크롤 또는 "더 보기" 방식으로 추가 로드

---

## UC-1-2. 카카오톡 링크 공유

> 시스템 설계: `시스템디자인.md` 섹션 3-A 참조

### 선행 조건

- 세션이 생성되어 editorToken이 발급된 상태

### 기본 플로우

1. 사용자가 세션 생성 완료 후 **"카카오톡 공유"** 버튼을 탭
2. 카카오톡 공유 SDK(Kakao Share API)를 통해 **커스텀 메시지 템플릿**이 생성됨
3. 카카오톡 앱이 열리며 대화방 선택 화면으로 이동
4. 사용자가 단체 톡방(또는 개별 대화방)을 선택하여 공유
5. 수신자가 톡방에서 공유된 카드를 탭하면 **세션 페이지(editorToken 포함 링크)** 로 이동

### 공유 메시지 구성

- **제목**: `{컨텐츠명} — {날짜}` (예: "롤 내전 — 2026.03.07 (토)")
- **설명**: `{시간} · 참가 {현재인원}/{전체인원}` (예: "19:00 · 참가 3/10")
- **썸네일**: 컨텐츠별 기본 이미지 (롤/풋살 각 1종)
- **버튼**: "참가하기" → 세션 링크로 이동

### 대안 플로우

- **A1. 카카오톡 미설치**: "링크 복사" 폴백 제공 → 클립보드에 세션 URL 복사
- **A2. 공유 후 재공유**: 세션 상세 화면 상단에 **"공유"** 버튼 상시 노출 → 언제든 재공유 가능
- **A3. 세션 상태 변경 시**: 공유된 링크는 항상 **최신 세션 상태**를 반영 (정적 스냅샷 아님)

### 기대 결과

- 로그인 없이 공유 링크를 통해 세션 접근 가능
- editorToken이 링크에 포함되어 수신자 모두 수정 권한을 가짐
- 카카오톡 앱 내에서 미리보기 카드(썸네일 + 제목 + 설명 + 버튼)가 정상 렌더링됨
- 카카오톡 미설치 환경에서도 링크 복사로 공유 가능

---

## UC-1-3. 세션 수정

### 선행 조건

- 세션이 생성된 상태 (status: `scheduled` 또는 `confirmed`)
- editor 또는 admin 권한

### 기본 플로우

1. 세션 셋업 또는 세션 상세 화면에서 **세션 정보 수정** 진입
2. 수정 가능 필드:
   - **제목(title)**: 자유 수정
   - **날짜/시간(startsAt)**: 자유 수정
3. 저장 시 즉시 반영

### 수정 가능 조건

| 세션 상태 | 제목 수정 | 날짜 수정 |
|-----------|:---------:|:---------:|
| scheduled | O | O |
| confirmed | O | O |
| done | **X** | **X** |

### 기대 결과

- 수정 후 기존 공유 링크는 그대로 유효 (URL에 날짜가 포함되지 않음)
- 날짜 변경 시 세션 목록 정렬 순서가 자동 갱신됨
- `done` 상태의 세션은 수정 불가 (읽기 전용)

---

## UC-1-4. 세션 삭제

### 선행 조건

- 세션이 존재하는 상태 (모든 status)
- **admin 권한 필수**

### 기본 플로우

1. 세션 상세(또는 셋업) 화면에서 **삭제** 버튼 탭
2. **확인 다이얼로그** 표시: "이 세션을 삭제하시겠습니까? 모든 매치, 사진, 댓글이 함께 삭제됩니다."
3. 사용자가 확인하면 세션 및 관련 데이터 일괄 삭제
4. 삭제 완료 후 세션 목록(홈) 화면으로 이동

### 삭제 cascade 범위

세션 삭제 시 다음 데이터가 **함께 삭제**된다:

| 대상 | 삭제 방식 |
|------|----------|
| Attendance | DB cascade |
| TeamPresetMember | DB cascade |
| Comment | DB cascade |
| Match → MatchTeamMember | DB cascade |
| Attachment (DB row) | DB cascade |
| Attachment (S3 파일) | **비동기 삭제** (삭제 실패해도 사용자 플로우 차단하지 않음) |
| ExtractionResult | DB cascade |

### 기대 결과

- 삭제된 세션의 공유 링크로 접근 시 "존재하지 않는 세션" 안내
- 삭제는 **hard delete** (복구 불가) — 확인 다이얼로그로 오삭제 방지
- S3 파일은 비동기로 정리되어 사용자 응답 지연 없음

---

## UC-2. 세션 셋업 (참가 + 팀 + 라인)

1. 세션 생성 후 셋업 화면 진입
2. Friend별 참가/불참/미정 설정 (대리 입력 포함)
3. ATTENDING 멤버를 Team A / Team B로 배정
4. (LoL) 팀 멤버별 기본 라인 설정
5. 완료(Confirm) 버튼으로 셋업 확정

**기대 결과**

- 참가자 카운트, 팀 구성, 라인 배정이 즉시 반영됨
- 확정 후 세션 상세 화면으로 전환

---

## UC-3. 세션 상세 조회 (확정 결과)

1. 셋업 확정 후 세션 상세 화면 접근 (링크 공유 포함)
2. 확정된 참가자/팀/라인 정보를 확인
3. 매치, 첨부, 댓글을 관리

**기대 결과**

- 셋업 정보는 읽기 전용으로 표시 (Attachment 0장이면 수정 가능)
- 매치 생성 시 팀 프리셋(팀 + 라인)이 자동 복사됨

---

## UC-4. 롤 매치 생성 및 진행

1. 세션 상세에서 Match 생성 → 세션 팀 프리셋(Team A/B + 라인) 자동 복사
2. 필요 시 매치별 라인/챔피언 수정
3. 매치 종료 후 결과 확정 플로우로 진행

**기대 결과**

- 세션 내 Match가 여러 개 생성 가능
- 매치마다 라인/챔피언이 기록됨

---

## UC-4-1. 매치 삭제

### 선행 조건

- 롤 세션이 `confirmed` 상태
- 삭제 대상 Match가 존재
- **admin 권한 필수**

### 기본 플로우

1. 세션 상세 화면에서 매치 카드의 **삭제** 버튼 탭
2. **확인 다이얼로그** 표시: "이 매치를 삭제하시겠습니까?"
3. 사용자가 확인하면 매치 및 관련 데이터 삭제

### 삭제 가능 조건

| 매치 상태 | isConfirmed | 삭제 가능 여부 |
|-----------|:-----------:|:-------------:|
| draft | false | **O** |
| lineup_locked | false | **O** |
| completed | false | **O** |
| completed | **true** | **X** (통계에 반영된 매치 보호) |

- `isConfirmed = true`인 매치는 삭제 불가 — 통계 무결성 보호
- admin이 삭제하려면 먼저 확정을 해제(`unconfirmMatch`)하는 별도 플로우 필요 (MVP 스킵 가능)

### 삭제 cascade 범위

| 대상 | 삭제 방식 |
|------|----------|
| MatchTeamMember | DB cascade |
| Attachment (MATCH scope, DB row) | DB cascade |
| Attachment (S3 파일) | 비동기 삭제 |
| ExtractionResult | DB cascade |

### 기대 결과

- 삭제 후 matchNo 재정렬 없음 (기존 번호 유지, 빈 번호 허용)
- 매치에 연결된 Attachment가 삭제되면 세션 전체 attachment count 감소 → effectiveLocked 재계산
- 확정된 매치 삭제 시도 시 에러 메시지: "확정된 매치는 삭제할 수 없습니다"

---

## UC-5. 롤 결과창 스샷 업로드 및 결과 확정

1. Match가 끝난 뒤 게임 종료 결과창 스샷 업로드(지원 포맷 1종)
2. 승/패 및 A↔Blue/Red 매핑을 스샷 기반으로 추출/표시
3. 사용자가 확인/수정 후 확정

**기대 결과**

- 확정된 Match만 집계에 포함
- 매치마다 진영(blue/red)은 변경될 수 있음

---

## UC-6. 풋살 기록 사진 업로드

1. 풋살 세션에서 사진을 업로드
2. 사진은 Attachments 영역에 저장됨(댓글 아님)

**기대 결과**

- 세션당 최대 10장 제한이 적용됨

---

## UC-7. 댓글로 커뮤니티 활성화

1. 세션 상세에서 텍스트 댓글 작성/삭제

**기대 결과**

- 텍스트만 가능(이미지 불가)
- editor/admin 모두 삭제 가능

---

## UC-8. 통계 개요 조회 (Stats Overview)

1. 통계 화면 진입 시 **전체 active Friend의 요약 통계**를 한눈에 확인
2. 각 Friend 행에 **승률(WR)**, **전적(W-L)**, **최다 라인(Top Lane)** 표시
3. 승률 내림차순으로 정렬 (동률 시 판수 많은 순 → 이름순)
4. 특정 Friend 행을 탭하면 **UC-8-1 상세 통계**로 이동

**기대 결과**

- 확정된 Match(`isConfirmed = true`)만 집계
- 매치 기록이 없는 Friend는 목록에 포함하되 "–" 표시
- 아카이브된 Friend는 기본 비노출

---

## UC-8-1. 친구별 상세 통계 조회 (Stats Detail)

1. Stats Overview에서 Friend를 선택하거나, 상세 화면 내 드롭다운으로 Friend 전환
2. 다음 지표를 확인:
   - **요약 카드**: 승률(%), 총 매치 수, 최다 라인
   - **라인 분포**: 라인별 플레이 횟수 (가로 바 차트, TOP → JG → MID → ADC → SUP 순)
   - **자주 이긴 챔피언**: 챔피언별 승수 / 판수 / 승률 (승수 내림차순, 상위 5개)
3. 선택적으로 기간 필터(startDate ~ endDate) 적용 가능

**기대 결과**

- 확정된 Match 데이터만 기준으로 통계 제공
- Friend는 전역 주소록 기준으로 누적됨
- 라인 분포는 TOP → JG → MID → ADC → SUP 고정 순서 표시

---

## UC-9. Friend 관리 (admin)

> Friends 탭 — 서비스 전역 주소록 관리. CRUD는 **admin 전용**, 목록 조회는 editor도 가능.

### 9-1. Friend 목록 조회

1. Friends 탭 진입 시 **전체 active Friend 목록** 표시
2. 각 행에 **표시명(displayName)**, **Riot ID(있으면)** 표시
3. 검색: 이름/Riot ID로 필터링 가능

**기대 결과**

- editor/admin 모두 조회 가능
- 아카이브된 Friend는 기본 비노출 (토글로 포함 가능)
- 정렬: displayName 가나다순

---

### 9-2. Friend 추가 (admin only)

1. Friends 화면에서 **"추가"** 버튼 탭
2. 입력 필드:
   - **표시명(displayName)**: 필수
   - **Riot Game Name**: 선택
   - **Riot Tag Line**: 선택
3. 저장

**기대 결과**

- 새 Friend가 목록에 즉시 반영
- 이후 생성되는 세션에서 Attendance 자동 생성 대상에 포함
- 이미 진행 중인 세션에는 영향 없음 (세션 생성 시점의 active Friend 기준)
- admin이 아닌 사용자가 시도 시 권한 에러

---

### 9-3. Friend 수정 (admin only)

1. Friends 목록에서 Friend 행을 탭하여 상세/수정 화면 진입
2. 수정 가능 필드: displayName, riotGameName, riotTagLine
3. 저장

**기대 결과**

- 수정 즉시 반영 — 세션 내 참가 목록, 통계 등에서 변경된 이름으로 표시
- Riot ID 변경 시 이후 OCR 매칭에 새 값 적용

---

### 9-4. Friend 아카이브 (admin only)

1. Friend 상세 화면에서 **"아카이브"** 버튼 탭
2. 확인 다이얼로그: "아카이브하면 새 세션에서 자동 추가되지 않습니다. 기존 기록은 유지됩니다."
3. 확인 시 `isArchived = true` 설정

**기대 결과**

- 아카이브된 Friend는 새 세션 생성 시 Attendance에 포함되지 않음
- 기존 세션/매치/통계 데이터는 **그대로 유지** (hard delete 아님)
- 통계 화면에서 기본 비노출 (includeArchived 옵션으로 확인 가능)
- **아카이브 해제(복원)** 가능: 다시 active 상태로 전환
